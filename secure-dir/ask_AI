#!/bin/env python3

import llm
import os
import json


def add_key():
    """Hỏi nhập key trước, nếu bỏ trống thì kiểm tra file cấu hình."""
    config_dir = os.path.expanduser("~/.config/llm")
    config_path = os.path.join(config_dir, "keys.json")

    user_key = input("Nhập Gemini API key (bỏ qua nếu đã có): ").strip()

    # --- Nếu người dùng nhập key ---
    if user_key:
        try:
            os.makedirs(config_dir, exist_ok=True)

            # Nếu file đã tồn tại → load, nếu không → tạo mới
            data = {}
            if os.path.exists(config_path):
                with open(config_path, encoding="utf-8") as f:
                    try:
                        data = json.load(f)
                    except json.JSONDecodeError:
                        data = {}

            data["gemini"] = user_key  # cập nhật key

            with open(config_path, "w", encoding="utf-8") as f:
                json.dump(data, f, indent=2)

            print(f" Đã lưu Gemini API key vào {config_path}\n")
            return

        except Exception as e:
            print(f" Lỗi khi lưu key: {e}")
            return

    # --- Nếu không nhập key ---
    if os.path.exists(config_path):
        try:
            with open(config_path, encoding="utf-8") as f:
                data = json.load(f)

            if "gemini" in data and data["gemini"].strip():
                print(" Đã phát hiện Gemini API key, bỏ qua bước thêm key.\n")
                return
            else:
                print(" Không tìm thấy key của Gemini trong file cấu hình.")
        except Exception as e:
            print(f" Lỗi đọc file config: {e}")
    else:
        print(" Không tìm thấy file cấu hình key.")

    print("\n Bạn cần nhập Gemini API key để tiếp tục.")
    add_key()  # hỏi lại


def analyze_file(file_path):
    print("***Truy cập https://aistudio.google.com/app/u/1/api-keys để lấy Gemini API key.***\n")
    add_key()

    model = llm.get_model("gemini-2.5-flash")

    attachments = [llm.Attachment(path=file_path)]

    try:
        print(" Đang phân tích, vui lòng chờ...")
        response = model.prompt(
            "Phân tích tệp đính kèm và đưa ra các hoạt động đáng chú ý hoặc bất thường được ghi lại trong tệp này. Xong rồi đưa ra tóm tắt ngắn gọn về những phát hiện chính.",
            attachments=attachments
        )
        print("=" * 40)
        print(response.text())
        print("=" * 40)

    except Exception as e:
        print(f" Lỗi khi gọi API: {e}")


def main():
    print("======== Kiểm tra log bằng Gemini AI ========")
    print("     (1) login.log")
    print("     (2) command_log.txt")

    choice = input("Chọn tệp để phân tích (1 hoặc 2): ").strip()

    cwd = os.getcwd() 
    if choice == '1':
        target = f"{cwd}/login.log"
    elif choice == '2':
        target = f"{cwd}/command_log.txt"
    else:
        print(" Lựa chọn không hợp lệ.")
        exit(1)

    analyze_file(target)


if __name__ == "__main__":
    main()
